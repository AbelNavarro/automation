- job:
    name: 'openstack-submit-project'
    node: openstack-trackupstream

    parameters:
      - string:
          name: project
          default: None
          description: name of the main project that should be updated with packages from its staging project
      - string:
          name: subproject
          default: None
          description: Name of the subproject that acts as staging project.
      - string:
          name: packagefilter
          default: None
          description: space separated strings to filter the packages by their names (from the beginning)
      - string:
          name: starttime
          default: None
          description: UNIX timestamp of when succeeding test was started to avoid copying broken versions
    wrappers:
      - build-name:
          name: 'submit ${ENV,var="project"}'

    builders:
      - shell: |
          # to debug set E=echo
          E=

          if [[ ! $starttime ]] ; then
              echo "FATAL: calling script needs to specify starttime"
              exit 1
          fi

          case $subproject in
              None) echo "No valid 'subproject' provided - defaults for safety reasons to 'None'"
                    exit 1
              ;;
              "-")  echo "Subproject set to '-': skip job, do not fail (eg. for Master project)"
                    exit 0
              ;;
          esac

          BS=IBS
          OSC="osc -A https://api.suse.de"

          COS=$project
          ECOS=""
          COSS=$COS:$subproject
          BS_CHECKOUT=/home/jenkins/${BS}_CHECKOUT/$COSS
          submitcmd="$OSC copypac -K -e"
          OSCBUILDDIST=SLE_12_SP1

          case $project in
              Devel:Cloud:6)
                  ECOS=systemsmanagement:crowbar:3.0
              ;;
              Devel:Cloud:6:SAP)
                  ECOS=systemsmanagement:crowbar:3.1
              ;;
              Devel:Cloud:7)
                  OSCBUILDDIST=SLE_12_SP2
                  ECOS=systemsmanagement:crowbar:4.0
              ;;
              Devel:Cloud:8)
                  OSCBUILDDIST=SLE_12_SP3
                  ECOS=systemsmanagement:crowbar:5.0
              ;;
              *) echo "Please add support for the project: $project"
                  exit 1
          esac

          pkg_filter=$(awk '$1=$1' <<< "${packagefilter}")
          pkg_filter="${pkg_filter// /|}"
          for component in `$OSC ls $COSS 2>/dev/null | grep -E "^(${pkg_filter})" | grep -v "^_product."` ; do
              cd $BS_CHECKOUT
              if [[ ! -d $component ]] ; then
                  $OSC co -o $component $COSS $component
              fi
              cd $component

              if ! grep -q "<linkinfo" .osc/_files ; then
                  echo "Error: package $component in $subproject (staging) is not a link to non-staging."
                  exit 2
              fi

              # avoid copying untested versions
              lastchange=$($OSC api "source/$COSS/$component/_history" | perl -ne 'if(m/<time>(\d+)</) {print $1; exit 0}')
              if [[ $lastchange -gt $starttime ]] ; then
                  echo "Skipping $component due to a change after the test in the previous job started. test start time: $starttime :: last change: $lastchange"
                  continue
              fi

              if $OSC rdiff $COS $component $COSS | grep .  && ( [ "$component" = "_product" ] || $OSC r $COSS $component -r $OSCBUILDDIST -a x86_64 | grep 'succeeded' )
              then
                  if [[ "$component" =~ -doc$ ]] ; then
                      continue
                  fi

                  # submit package
                  $E $submitcmd $COSS $component $COS || :
                  if [[ $ECOS && $component =~ ^crowbar ]] ; then
                      $E $submitcmd $COSS $component -t https://api.opensuse.org/ $ECOS || :
                  fi
              fi
          done
